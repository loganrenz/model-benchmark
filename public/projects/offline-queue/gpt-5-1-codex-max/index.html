<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Offline Task Queue</title>
  <style>
    :root { --bg:#0b1220; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; --border:#1f2937; }
    *{box-sizing:border-box;} body{margin:0;font-family:"Inter",sans-serif;background:var(--bg);color:var(--text);padding:16px;}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px;}
    .pill{padding:6px 10px;border-radius:14px;background:var(--panel);border:1px solid var(--border);color:var(--muted);}
    button{background:var(--accent);color:#0b1220;border:none;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer;}
    button.secondary{background:var(--panel);color:var(--text);border:1px solid var(--border);} input,select{padding:8px;border-radius:8px;border:1px solid var(--border);background:#0f172a;color:var(--text);} 
    main{display:grid;grid-template-columns:2fr 1.2fr;gap:16px;} .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;} h2{margin:0 0 10px;}
    ul{list-style:none;padding:0;margin:0;display:grid;gap:8px;} li{padding:10px;border-radius:8px;background:#0f172a;border:1px solid var(--border);} small{color:var(--muted);} 
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    textarea{width:100%;height:120px;resize:vertical;background:#0f172a;border:1px solid var(--border);color:var(--text);padding:8px;border-radius:8px;}
  </style>
</head>
<body>
  <header>
    <div>
      <h1 style="margin:0">Offline-First Task Queue</h1>
      <div class="pill">Queue length: <span id="queueCount">0</span> • Last sync: <span id="lastSync">never</span></div>
    </div>
    <div class="row">
      <button id="toggleMode">Go Offline</button>
      <button id="export">Export JSON</button>
      <label class="row" style="color:var(--muted)"><input type="file" id="import" accept="application/json" style="width:160px" />Import</label>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>Create / Edit Task</h2>
      <div class="row">
        <input id="title" placeholder="Title" />
        <select id="priority">
          <option value="low">Low</option>
          <option value="medium" selected>Medium</option>
          <option value="high">High</option>
        </select>
        <button id="save">Save</button>
      </div>
    </section>

    <section class="card">
      <h2>Event Log</h2>
      <ul id="log"></ul>
    </section>

    <section class="card" style="grid-column: span 2;">
      <h2>Tasks</h2>
      <ul id="tasks"></ul>
    </section>
  </main>

  <script>
    const state = { online: true, queue: [], editingId: null };
    const logEl = document.getElementById('log');
    const tasksEl = document.getElementById('tasks');
    const queueCount = document.getElementById('queueCount');
    const lastSync = document.getElementById('lastSync');
    const titleInput = document.getElementById('title');
    const priorityInput = document.getElementById('priority');

    const dbName = 'offline-task-db';
    let db;

    function log(msg) {
      const li = document.createElement('li');
      li.textContent = `${new Date().toLocaleTimeString()} — ${msg}`;
      logEl.prepend(li);
    }

    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(dbName, 1);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          db.createObjectStore('tasks', { keyPath: 'id' });
        };
        req.onsuccess = () => { db = req.result; resolve(); };
        req.onerror = () => reject(req.error);
      });
    }

    function tx(store, mode = 'readonly') {
      return db.transaction(store, mode).objectStore(store);
    }

    function saveTask(task) {
      return new Promise((resolve, reject) => {
        const req = tx('tasks', 'readwrite').put(task);
        req.onsuccess = () => resolve();
        req.onerror = () => reject(req.error);
      });
    }

    function deleteTask(id) {
      return new Promise((resolve, reject) => {
        const req = tx('tasks', 'readwrite').delete(id);
        req.onsuccess = () => resolve();
        req.onerror = () => reject(req.error);
      });
    }

    function getAllTasks() {
      return new Promise((resolve, reject) => {
        const req = tx('tasks').getAll();
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    function renderTasks(tasks) {
      tasksEl.innerHTML = '';
      tasks.forEach((task) => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${task.title}</strong><br><small>${task.priority.toUpperCase()} • ${new Date(task.createdAt).toLocaleString()}</small>`;
        const row = document.createElement('div');
        row.className = 'row';
        const edit = document.createElement('button'); edit.textContent = 'Edit'; edit.className = 'secondary';
        const del = document.createElement('button'); del.textContent = 'Delete'; del.className = 'secondary';
        edit.onclick = () => { state.editingId = task.id; titleInput.value = task.title; priorityInput.value = task.priority; };
        del.onclick = () => queueAction({ type: 'delete', id: task.id });
        row.append(edit, del);
        li.appendChild(row);
        tasksEl.appendChild(li);
      });
    }

    function queueAction(action) {
      if (!state.online) {
        state.queue.push(action);
        updateQueueUI();
        log(`Queued action: ${action.type}`);
      } else {
        applyAction(action).then(() => syncComplete());
      }
    }

    function applyAction(action) {
      if (action.type === 'delete') return deleteTask(action.id);
      if (action.type === 'save') return saveTask(action.task);
      return Promise.resolve();
    }

    async function processQueue() {
      if (state.queue.length === 0) return;
      for (const action of state.queue) {
        await applyAction(action);
      }
      state.queue = [];
      updateQueueUI();
      syncComplete();
    }

    function updateQueueUI() {
      queueCount.textContent = state.queue.length;
    }

    function syncComplete() {
      lastSync.textContent = new Date().toLocaleTimeString();
      refreshTasks();
    }

    async function refreshTasks() {
      const tasks = await getAllTasks();
      renderTasks(tasks);
    }

    document.getElementById('toggleMode').onclick = async () => {
      state.online = !state.online;
      document.getElementById('toggleMode').textContent = state.online ? 'Go Offline' : 'Go Online';
      log(state.online ? 'Went online. Replaying queue...' : 'Switched offline. Actions will queue.');
      if (state.online) await processQueue();
    };

    document.getElementById('save').onclick = () => {
      const title = titleInput.value.trim();
      if (!title) return alert('Title required');
      const task = {
        id: state.editingId || crypto.randomUUID(),
        title,
        priority: priorityInput.value,
        createdAt: state.editingId ? Date.now() : Date.now(),
      };
      state.editingId = null;
      titleInput.value = '';
      queueAction({ type: 'save', task });
    };

    document.getElementById('export').onclick = async () => {
      const tasks = await getAllTasks();
      const blob = new Blob([JSON.stringify(tasks, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'tasks.json';
      a.click();
      URL.revokeObjectURL(url);
    };

    document.getElementById('import').onchange = (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async () => {
        try {
          const data = JSON.parse(reader.result);
          for (const task of data) {
            await saveTask(task);
          }
          log('Imported tasks');
          refreshTasks();
        } catch (err) {
          alert('Invalid file');
        }
      };
      reader.readAsText(file);
    };

    async function init() {
      await openDB();
      refreshTasks();
    }
    init();
  </script>
</body>
</html>
